<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="description" content="1">

        <meta property="og:title" content="Only allow owner to update their user profile in Laravel with a policy | Martin Betz"/>
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://martinbetz.eu/articles/only-allow-owner-to-update-their-user-profile-in-laravel-with-a-policy"/>
        <meta property="og:description" content="Articles, services and products of Martin Betz" />

        <title>Martin Betz | Only allow owner to update their user profile in Laravel with a policy</title>

        <link rel="home" href="https://martinbetz.eu">
        <link rel="icon" href="/favicon.ico?v=5">
        <link href="/rss/feed.atom" type="application/atom+xml" rel="alternate" title="Martin Betz Atom Feed">

            <meta property="og:title" content="Only allow owner to update their user profile in Laravel with a policy" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://martinbetz.eu/articles/only-allow-owner-to-update-their-user-profile-in-laravel-with-a-policy"/>
    <meta property="og:description" content="Only allow owner to update their user profile in Laravel with a policy" />

        <link rel="stylesheet" href="/assets/build/css/main.css?id=744c4fc9b5c9695b1ae3">
        <script async defer data-domain="martinbetz.eu" src="https://stats.martinbetz.eu/js/plausible.js"></script>
        <script>window.plausible = window.plausible || function() { (window.plausible.q = window.plausible.q || []).push(arguments) }</script>
    </head>

    <body class="flex flex-col justify-between min-h-screen bg-gray-100 text-gray-900 leading-normal font-sans">
        <header class="border-t-2 border-blue-400 flex items-center shadow bg-white h-24 py-4" role="banner">
            <div class="container flex items-center max-w-6xl mx-auto px-4 lg:px-8">
                <div class="flex items-center">
                    <a href="/" title="Martin Betz home" class="inline-flex items-center">
                        <h1 class="text-2xl md:text-3xl text-blue font-semibold my-0">Martin Betz</h1>
                    </a>
                </div>

                <div class="flex flex-1 justify-end items-center">


                    <nav class="hidden lg:flex items-center justify-end text-lg">
    <a title="Martin Betz Articles" href="/articles"
        class="text-xl ml-6 text-gray-900 hover:text-blue-600 ">
        Articles
    </a>

    <a title="Martin Betz Products" href="/products"
        class="text-xl ml-6 text-gray-900 hover:text-blue-600 ">
        Products
    </a>

    <a title="Martin Betz Services" href="/services"
        class="text-xl ml-6 text-gray-900 hover:text-blue-600 ">
        Services
    </a>

    <a title="Martin Betz Contact" href="/contact"
        class="text-xl ml-6 text-gray-900 hover:text-blue-600 ">
        Contact
    </a>

    <a href="/rss/feed.atom">
    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-xl ml-6 text-gray-900 hover:text-blue-600" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg>
    </a>
</nav>

                    <button class="flex justify-center items-center bg-blue border border-blue h-10 px-5 rounded-full lg:hidden focus:outline-none"
    onclick="navMenu.toggle()"
>
    <svg id="js-nav-menu-show" xmlns="http://www.w3.org/2000/svg"
        class="fill-current text-white h-9 w-4" viewBox="0 0 32 32"
    >
        <path d="M4,10h24c1.104,0,2-0.896,2-2s-0.896-2-2-2H4C2.896,6,2,6.896,2,8S2.896,10,4,10z M28,14H4c-1.104,0-2,0.896-2,2  s0.896,2,2,2h24c1.104,0,2-0.896,2-2S29.104,14,28,14z M28,22H4c-1.104,0-2,0.896-2,2s0.896,2,2,2h24c1.104,0,2-0.896,2-2  S29.104,22,28,22z"/>
    </svg>

    <svg id="js-nav-menu-hide" xmlns="http://www.w3.org/2000/svg"
        class="hidden fill-current text-white h-9 w-4" viewBox="0 0 36 30"
    >
        <polygon points="32.8,4.4 28.6,0.2 18,10.8 7.4,0.2 3.2,4.4 13.8,15 3.2,25.6 7.4,29.8 18,19.2 28.6,29.8 32.8,25.6 22.2,15 "/>
    </svg>
</button>

                </div>
            </div>
        </header>

        <nav id="js-nav-menu" class="nav-menu hidden lg:hidden">
    <ul class="my-0">
        <li class="pl-4">
            <a
                title="Martin Betz Articles"
                href="/articles"
                class="nav-menu__item hover:text-blue "
            >Articles</a>
        </li>
        <li class="pl-4">
            <a
                title="Martin Betz Products"
                href="/products"
                class="nav-menu__item hover:text-blue "
            >Products</a>
        </li>
        <li class="pl-4">
            <a
                title="Martin Betz Services"
                href="/services"
                class="nav-menu__item hover:text-blue "
            >Services</a>
        </li>
        <li class="pl-4">
            <a
                title="Martin Betz Contact"
                href="/contact"
                class="nav-menu__item hover:text-blue "
            >Contact</a>
        </li>
    </ul>
</nav>

        <main role="main" class="flex-auto w-full container max-w-6xl mx-auto py-16 px-6">


                
    <h1 class="leading-none mb-2">Only allow owner to update their user profile in Laravel with a policy</h1>
    <p class="text-gray-600 font mt-0 text-base">April 10, 2020   •  Last updated: April 10, 2019</p>

    <div class="rich-text pb-4" v-pre>
        <h2>The problem: Only owners should be allowed to edit their profiles</h2>
<ul>
<li>You have a website that lists the profile of Laravel developers</li>
<li>The profile is just an extension of the <code>User</code> model, so you have extra fields</li>
<li>For sake of simplicity, you have only one field in your profile that is the numbers of years you've been coding with Laravel</li>
<li>Developers listed should only be able to edit their own profile and not foreign profiles</li>
</ul>
<h2>The solution: Use a policy for the User model</h2>
<ul>
<li>We will write a <a href="https://laravel.com/docs/7.x/authorization#creating-policies">policy</a> that will be triggered when a user updates a profile</li>
<li>The policy checks whether you are the owner of the user profile</li>
<li>If you are, you can update the profile</li>
<li>If you are not the owner, your request will be denied</li>
</ul>
<h2>The step by step explanation</h2>
<ul>
<li>I will show you how to add this policy test-driven</li>
<li>I assume that you already created a fresh Laravel app and set up your database</li>
</ul>
<h3>Step 1: Write a failing test <code>user_can_update_own_profile</code></h3>
<ul>
<li>Create a test for the User model: <code>php artisan make:test Http/Controllers/UserControllerTest</code></li>
<li>We will write a test with how we wish our app should work if we are the owner of a profile</li>
<li>This is called the <em>Happy Path</em></li>
</ul>
<pre><code class="language-php">// tests/Feature/Http/Controllers/UserControllerTest.php

&lt;?php

namespace Tests\Feature\Http\Controllers;

use App\User;
use Tests\TestCase;
use Illuminate\Foundation\Testing\RefreshDatabase;

class UserControllerTest extends TestCase
{
    use RefreshDatabase;

    /** @test */
    public function user_can_update_own_profile()
    {
        $user = factory(User::class)-&gt;create();
        $response = $this-&gt;actingAs($user)-&gt;post(route('user.profile.update', $user), [
            'experience_years' =&gt; 5,
        ]);

        $response-&gt;assertSuccessful();
        $user-&gt;refresh();
        $this-&gt;assertEquals(5, $user-&gt;experience_years);
    }
}</code></pre>
<ul>
<li>This test will fail for many reasons
<ul>
<li>We do not have a route named <code>user.profile.update</code> that we can send a <code>POST</code> request to</li>
<li>We do not have a <code>experience_years</code> property on the <code>User</code> model</li>
<li>We do not have a User controller that actually updates the model</li>
</ul></li>
<li>In a normal test-driven process, I would solve this error by error</li>
<li>As this tutorial is about policies, I will just solve all problems at once to get to the policy part</li>
</ul>
<h3>Step 2: Fix the test to assert that you can update your own profile</h3>
<ul>
<li>The solution: Update your migration, <code>User</code> model, <code>web.php</code> routes file and create a <code>UserController</code> with an <code>update</code> method that updates with everything passed with a request</li>
<li>I marked all new files with a <code>// ADD:</code> comment</li>
<li>I deleted all comments and unneccessary lines</li>
</ul>
<pre><code class="language-php">// Migration: database/migrations/2014_10_12_000000_create_users_table.php
// Your date in the filename should differ

&lt;?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

class CreateUsersTable extends Migration
{
    public function up()
    {
        Schema::create('users', function (Blueprint $table) {
            $table-&gt;id();
            $table-&gt;string('name');
            $table-&gt;string('email')-&gt;unique();
            $table-&gt;integer('experience_years')-&gt;nullable(); // ADD: nullable integer
            $table-&gt;timestamp('email_verified_at')-&gt;nullable();
            $table-&gt;string('password');
            $table-&gt;rememberToken();
            $table-&gt;timestamps();
        });
    }

    public function down()
    {
        Schema::dropIfExists('users');
    }
}
</code></pre>
<pre><code class="language-php">// User Model: app/User.php

&lt;?php

namespace App;

use Illuminate\Contracts\Auth\MustVerifyEmail;
use Illuminate\Foundation\Auth\User as Authenticatable;
use Illuminate\Notifications\Notifiable;

class User extends Authenticatable
{
    use Notifiable;

    protected $fillable = [
        'name', 'email', 'password', 'experience_years' // ADD: 'experience_years'
    ];

    protected $hidden = [
        'password', 'remember_token',
    ];

    protected $casts = [
        'email_verified_at' =&gt; 'datetime',
    ];
}
</code></pre>
<pre><code class="language-php">// Routes: routes/web.php

&lt;?php

use Illuminate\Support\Facades\Route;

Route::post('/{user}/profile/update', 'UserController@update')-&gt;name('user.profile.update');
</code></pre>
<pre><code class="language-php">// Controller: app/Http/Controllers/UserController.php

&lt;?php

namespace App\Http\Controllers;

use App\User;
use Illuminate\Http\Request;

class UserController extends Controller
{
    public function update(Request $request, User $user)
    {
        $user-&gt;update($request-&gt;all());
    }
}</code></pre>
<ul>
<li>You can now run the tests with <code>php artisan test</code>.</li>
<li>You should see two passing example tests and a passing test: <code>✓ user can update own profile</code></li>
<li>Let's try to update someone else's years of experience:</li>
</ul>
<h3>Step 3: Try to update someone else's profile – and fail</h3>
<pre><code class="language-php">/** @test */
    public function user_cannot_update_foreign_profile()
    {
        $user = factory(User::class)-&gt;create();
        $foreign_user = factory(User::class)-&gt;create([
            'experience_years' =&gt; 2,
        ]);
        $response = $this-&gt;actingAs($user)-&gt;post(route('user.profile.update', $foreign_user), [
            'experience_years' =&gt; 5,
        ]);

        $response-&gt;assertForbidden();
        $foreign_user-&gt;refresh();
        $this-&gt;assertEquals(2, $foreign_user-&gt;experience_years);
    }</code></pre>
<ul>
<li>This test will fail <code>Asserting that 5 is 2</code></li>
<li>This means: Yes, we can change someone else's profile</li>
<li>Not good!</li>
</ul>
<h3>Step 4: Add a policy to disallow changing someone else's profile</h3>
<ul>
<li>Solution: Add a policy to stopp this</li>
<li>Create the policy: <code>php artisan make:policy UserPolicy</code></li>
</ul>
<pre><code class="language-php">// Policy: app/Policies/UserPolicy.php

&lt;?php

namespace App\Policies;

use App\User;
use Illuminate\Auth\Access\Response;
use Illuminate\Auth\Access\HandlesAuthorization;

class UserPolicy
{
    use HandlesAuthorization;

    public function update(User $user, User $user_model)
    {
        return $user-&gt;id === $user_model-&gt;id ? Response::allow() : Response::deny();
    }
}
</code></pre>
<ul>
<li>Policies always have the current user passed via <code>User $user</code></li>
<li>The second argument is the model that we want to protect</li>
<li>Because we want to protect the user model, we need to pass it twice with differing names</li>
<li>Interpretation of the command: If the ID of the currently logged in user is the same as the id of the user model that is being tried to update, allow the update. If not, reject the update</li>
<li>Because we named the policy like the model, Laravel automatically finds it</li>
<li>We only need to apply the policy on the route</li>
</ul>
<pre><code class="language-php">// Routes with policy: routes/web.php

&lt;?php

use Illuminate\Support\Facades\Route;

Route::post('/{user}/profile/update', 'UserController@update')-&gt;name('user.profile.update')-&gt;middleware('can:update,user');
</code></pre>
<p>The <code>-&gt;middleware('can:update,user)</code> means: Authorize the <code>update()</code> action and pass the <code>user</code> URL parameter to the policy (that's our <code>$user_model</code> in the policy).</p>
<h2>Repo and extension</h2>
<ul>
<li>If you have problems following the code, check out the repo on <a href="https://github.com/minthemiddle/200410-listing">Github</a>.</li>
<li>If you want to extend this functionality, try to add an exception for admins: They should be able to change every profile</li>
</ul>    </div>

        <div class="text-center mt-12 mb-12 bg-gray-200 p-8 border-t-4 border-blue-500">
        <div class="font-bold text-blue-600">Send me your feedback on</div>
        <div>"Only allow owner to update their user profile in Laravel with a policy"</div>
        <p class="flex justify-center" id="cntct-article"></p>
    </div>
    
    <div class="border-b border-t border-blue-100 mt-4 pb-4 pt-4 mb-10">
        <p class="text-gray-600 text-xl md:mt-0">April 10, 2020   •  Last updated: April 10, 2019</p>


                    <p>
                            <a
                    href="/categories/tech"
                    title="View posts in tech"
                    class="text-sm tracking-wide bg-white text-gray-600 p-2  uppercase"
                >tech</a>
                        </p>
        </div>

    <nav class="flex justify-between text-sm md:text-base">
        <div>
                            <a href="https://martinbetz.eu/articles/todo-paper-audio-todoist" title="Older Post: How I manage my todos">
                    &LeftArrow; How I manage my todos
                </a>
                    </div>

        <div>
                            <a href="https://martinbetz.eu/articles/premium-laravel" title="Newer Post: Premium Laravel courses and books">
                    Premium Laravel courses and books &RightArrow;
                </a>
                    </div>
    </nav>
        </main>

        <footer class="bg-white text-center text-sm mt-12 py-4 pin-b" role="contentinfo">

            <ul class="flex flex-col md:flex-row justify-center">
                <li class="md:mr-2">
                    &copy; Martin Betz 2020.
                </li>

                <li>
                    <a href="/privacy">Privacy/GDPR </a>
                </li>
                <li class="ml-2">
                     <a href="/imprint">Imprint</a>
                </li>
                <li class="ml-2">
                    <span id="cntct-me"></span>
                </li>
            </ul>
        </footer>

        <script src="/assets/build/js/main.js?id=f4391a1bf44752fd065c"></script>
        <script>
            var el = document.getElementById('cntct-me');
            EO(el, {
              name: 'contact+me',
              domain: 'martinbetz',
              tld: 'eu',
              altText: 'Email'
            });
        </script>

        <script>
var el = document.getElementById('cntct-article');
var base = 'feedback+';
var final = base.concat('update-own-model-laravel');
EO(el, {
  name: final,
  domain: 'martinbetz',
  tld: 'eu',
  altText: 'Email'
});
</script>
<script>
    const navMenu = {
        toggle() {
            const menu = document.getElementById('js-nav-menu');
            menu.classList.toggle('hidden');
            menu.classList.toggle('lg:block');
            document.getElementById('js-nav-menu-hide').classList.toggle('hidden');
            document.getElementById('js-nav-menu-show').classList.toggle('hidden');
        },
    }
</script>
    </body>
</html>
